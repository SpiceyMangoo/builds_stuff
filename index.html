<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- [Previous CSS styles remain the same] --- */
        
        :root {
            --font-main: 'Poppins', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            --bg-color-light: #f0f2f5;
            --glass-bg-light: rgba(255, 255, 255, 0.55);
            --text-color-light: #1c1c1e;
            --text-secondary-light: #5a5a5f;
            --border-color-light: rgba(0, 0, 0, 0.1);
            --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --glow-light: 0 0 15px rgba(31, 38, 135, 0.2);
            --accent-color-light: #007aff;
            --success-color-light: #34c759;
            --warning-color-light: #ff9500;
            --locked-in-glow-light: 0 0 20px rgba(0, 122, 255, 0.6);
            --locked-in-badge-bg-light: #007aff;
            --bg-color-dark: #1c1c1e;
            --glass-bg-dark: rgba(44, 44, 46, 0.7);
            --text-color-dark: #f2f2f7;
            --text-secondary-dark: #b1b1b3;
            --border-color-dark: rgba(255, 255, 255, 0.15);
            --shadow-dark: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --glow-dark: 0 0 15px rgba(0, 122, 255, 0.3);
            --accent-color-dark: #0a84ff;
            --success-color-dark: #32d74b;
            --warning-color-dark: #ff9f0a;
            --locked-in-glow-dark: 0 0 20px rgba(10, 132, 255, 0.7);
            --locked-in-badge-bg-dark: #0a84ff;
        }
        body {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
            font-family: var(--font-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 1rem;
        }
        body.dark-mode {
            --bg-color-light: var(--bg-color-dark);
            --glass-bg-light: var(--glass-bg-dark);
            --text-color-light: var(--text-color-dark);
            --text-secondary-light: var(--text-secondary-dark);
            --border-color-light: var(--border-color-dark);
            --shadow-light: var(--shadow-dark);
            --glow-light: var(--glow-dark);
            --accent-color-light: var(--accent-color-dark);
            --success-color-light: var(--success-color-dark);
            --warning-color-light: var(--warning-color-dark);
            --locked-in-glow-light: var(--locked-in-glow-dark);
            --locked-in-badge-bg-light: var(--locked-in-badge-bg-dark);
        }
        .app-wrapper { max-width: 1400px; margin: 0 auto; }
        .card { background: var(--glass-bg-light); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: 1rem; border: 1px solid var(--border-color-light); box-shadow: var(--shadow-light); padding: 1.5rem; transition: all 0.3s ease; }
        .app-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        header { display: flex; justify-content: space-between; align-items: center; }
        main { display: grid; grid-template-areas: "tools" "dashboard" "log"; gap: 1.5rem; }
        #dashboard { grid-area: dashboard; }
        #tools { grid-area: tools; }
        #log-panel { grid-area: log; }
        @media (min-width: 1024px) { main { grid-template-columns: 350px 1fr; grid-template-rows: auto 1fr; grid-template-areas: "tools dashboard" "tools log"; } }
        h1, h2, h3 { margin: 0 0 1rem 0; color: var(--text-color-light); font-weight: 600; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.4rem; border-bottom: 1px solid var(--border-color-light); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        h3 { font-size: 1rem; color: var(--text-secondary-light); font-weight: 400; }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 2px; content: ""; height: 20px; left: 2px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color-light); }
        input:checked + .slider:before { transform: translateX(24px); }
        button, input, select { width: 100%; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color-light); background-color: rgba(120,120,128,0.12); color: var(--text-color-light); font-family: var(--font-main); font-size: 1rem; box-sizing: border-box; }
        input:disabled { background-color: rgba(120,120,128,0.06); cursor: not-allowed; }
        button { background-color: var(--accent-color-light); color: white; border: none; cursor: pointer; font-weight: 600; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--glow-light); }
        button.secondary { background-color: var(--text-secondary-light); }
        button:disabled { background-color: #555; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }
        #dashboard-content { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 768px) { #dashboard-content { grid-template-columns: 1fr 280px; } }
        .charts-container { display: flex; flex-direction: column; gap: 1.5rem; }
        
        /* --- THE FIX IS HERE --- */
        .chart-wrapper {
            position: relative;
            height: 250px; /* Give it a defined height */
        }
        @media (min-width: 768px) {
            .chart-wrapper { height: 280px; }
        }
        /* --- END OF FIX --- */

        .chart-filters { display: flex; gap: 0.5rem; justify-content: center; }
        .chart-filters button { background: none; border: 1px solid var(--border-color-light); color: var(--text-secondary-light); padding: 0.25rem 0.75rem; font-size: 0.8rem; }
        .chart-filters button.active { background-color: var(--accent-color-light); color: white; border-color: var(--accent-color-light); }
        .stats-sidebar { display: flex; flex-direction: column; gap: 1.25rem; }
        .progress-wrapper { background-color: rgba(120,120,128,0.12); border-radius: 0.75rem; padding: 4px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-bar-container { width: 100%; background-color: transparent; border-radius: 0.5rem; overflow: hidden; }
        .progress-bar { width: 0%; height: 22px; background-color: var(--accent-color-light); transition: width 0.5s ease-in-out; text-align: center; color: white; font-size: 0.8rem; line-height: 22px; font-weight: 600; border-radius: 0.5rem; }
        #goalProgressBar { background-color: var(--success-color-light); }
        .stat-item { text-align: center; }
        .stat-value { font-weight: 700; font-size: 2rem; color: var(--accent-color-light); }
        .stat-label { font-size: 0.9rem; color: var(--text-secondary-light); }
        #interruptionsValue { color: var(--warning-color-light); }
        #targetHoursDisplay { font-weight: 600; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center; }
        #timer-display { font-size: 4rem; font-weight: 700; text-align: center; margin: 1rem 0; color: var(--accent-color-light); }
        #customPomodoroInputs { display: none; }
        .timer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        #log-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color-light); }
        .log-item:last-child { border-bottom: none; }
        .log-item .status-completed { color: var(--success-color-light); font-weight: 600; }
        .log-item .status-stopped { color: #ff3b30; font-weight: 600; }
        #lockedInBadge { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); background-color: var(--locked-in-badge-bg-light); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 600; z-index: 1000; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        body.locked-in #lockedInBadge { opacity: 1; }
        body.locked-in button:hover:not(:disabled) { box-shadow: var(--locked-in-glow-light); }
        #greetingModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #greetingModal.visible { opacity: 1; pointer-events: all; }
        #greetingModal .card { max-width: 400px; text-align: center; }

    </style>
</head>
<body>
<div class="app-wrapper">
    <div id="lockedInBadge">LOCKED IN</div>

    <div id="greetingModal">
        <div class="card">
            <h2 id="greetingMessage"></h2>
            <p>Set your target for today.</p>
            <form id="goalForm">
                <input type="number" id="goalHoursInput" min="1" max="24" placeholder="Enter Goal Hours (e.g., 8)" required>
                <button type="submit">Set Goal & Start</button>
            </form>
        </div>
    </div>

    <div class="app-container">
        <header>
            <h1>Dashboard</h1>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="themeToggle">
                    <input type="checkbox" id="themeToggle" />
                    <span class="slider round"></span>
                </label>
            </div>
        </header>

        <main>
            <div id="tools" class="card">
                <h2>Tools Suite</h2>
                <div id="timer-display">00:00</div>
                <input type="text" id="taskDescription" placeholder="What are you working on?">
                
                <h3>Timer Mode</h3>
                <select id="timerModeSelect">
                    <optgroup label="Pomodoro">
                        <option value="pomo-25-5">Standard Pomodoro (25/5)</option>
                        <option value="pomo-90-15">Deep Work (90/15)</option>
                        <option value="pomo-60-10">Focused (60/10)</option>
                        <option value="pomo-custom">Custom Pomodoro</option>
                    </optgroup>
                    <optgroup label="Logger">
                        <option value="log-work">Work Logger</option>
                        <option value="log-break">Break Logger</option>
                        <option value="log-leisure">Leisure Logger</option>
                    </optgroup>
                </select>

                <div id="customPomodoroInputs">
                    <input type="number" id="customWork" placeholder="Custom Work (mins)">
                    <input type="number" id="customBreak" placeholder="Custom Break (mins)">
                </div>

                <div class="timer-controls">
                    <button id="startTimerBtn">Start</button>
                    <button id="pauseTimerBtn" class="secondary" disabled>Pause</button>
                </div>
                <button id="stopTimerBtn" disabled>Stop</button>
            </div>

            <div id="dashboard" class="card">
                <div id="dashboard-content">
                    <div class="charts-container">
                        <div>
                            <h2>Activities Split (Today)</h2>
                            <div class="chart-wrapper">
                                <canvas id="activitiesChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h2>Productivity Trend</h2>
                             <div class="chart-wrapper">
                                <canvas id="trendChart"></canvas>
                            </div>
                            <div class="chart-filters">
                                <button class="filter-btn active" data-period="7">7 Days</button>
                                <button class="filter-btn" data-period="30">30 Days</button>
                            </div>
                        </div>
                    </div>
                    <div class="stats-sidebar">
                        <h2>Metrics</h2>
                        <div class="metrics-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="streak">0</div>
                                <div class="stat-label">Completed Streak</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="interruptionsValue">0</div>
                                <div class="stat-label">Interruptions</div>
                            </div>
                        </div>
                        <div>
                            <h3>Your Focus Today</h3>
                            <div class="progress-wrapper">
                                <div class="progress-bar-container">
                                    <div class="progress-bar" id="focusProgressBar"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3>Productivity Level</h3>
                            <div class="stat-label">Target: <span id="targetHoursDisplay">-</span> hrs</div>
                            <div class="progress-wrapper">
                                <div class="progress-bar-container">
                                    <div class="progress-bar" id="goalProgressBar"></div>
                                </div>
                            </div>
                        </div>
                        <button id="exportCsv" style="margin-top: 1rem;">Export to CSV</button>
                    </div>
                </div>
            </div>

            <div id="log-panel" class="card">
                <h2>Today's Log</h2>
                <ul id="log-list"></ul>
            </div>
        </main>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM ELEMENT REFERENCES ---
    const greetingModal = document.getElementById('greetingModal');
    const greetingMessage = document.getElementById('greetingMessage');
    const goalForm = document.getElementById('goalForm');
    const goalHoursInput = document.getElementById('goalHoursInput');
    const timerDisplay = document.getElementById('timer-display');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const timerModeSelect = document.getElementById('timerModeSelect');
    const customPomodoroInputs = document.getElementById('customPomodoroInputs');
    const customWorkInput = document.getElementById('customWork');
    const customBreakInput = document.getElementById('customBreak');
    const startTimerBtn = document.getElementById('startTimerBtn');
    const pauseTimerBtn = document.getElementById('pauseTimerBtn');
    const stopTimerBtn = document.getElementById('stopTimerBtn');
    const logList = document.getElementById('log-list');
    const streakDisplay = document.getElementById('streak');
    const interruptionsValue = document.getElementById('interruptionsValue');
    const focusProgressBar = document.getElementById('focusProgressBar');
    const targetHoursDisplay = document.getElementById('targetHoursDisplay');
    const goalProgressBar = document.getElementById('goalProgressBar');

    let activitiesChart, trendChart;
    let appData = { goalHours: null, lastGreeting: null, activityLog: [] };
    let timerInterval = null;
    let timerState = {
        running: false,
        paused: false,
        startTime: null,
        pauseStartTime: null,
        accumulatedPauseTime: 0,
        plannedDuration: 0,
        timeRemaining: 0,
        type: null,
        category: 'Work',
        taskDescription: '',
        isBreak: false,
        breakDuration: 0
    };

    // =================================================================
    // --- 1. INITIALIZATION & DATA ---
    // =================================================================
    function loadData() {
        const savedData = localStorage.getItem('productivityDashboard');
        if (savedData) appData = JSON.parse(savedData);
        if (!Array.isArray(appData.activityLog)) appData.activityLog = [];
    }

    function saveData() {
        localStorage.setItem('productivityDashboard', JSON.stringify(appData));
    }

    function initializeApp() {
        loadData();
        setupTheme();
        initializeCharts();
        checkGreeting();
        updateAllUI();
        setupEventListeners();
    }

    function setupTheme() {
        const themeToggle = document.getElementById('themeToggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.body.classList.add('dark-mode');
            themeToggle.checked = true;
        }
        themeToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        });
    }

    function checkGreeting() {
        const today = new Date().toDateString();
        if (appData.lastGreeting !== today || !appData.goalHours) {
            const now = new Date();
            const twoAM = new Date();
            twoAM.setDate(now.getDate() + 1);
            twoAM.setHours(2, 0, 0, 0);

            const hoursLeft = Math.floor((twoAM - now) / (1000 * 60 * 60));
            greetingMessage.textContent = `There are ${hoursLeft} hours left in your day. Let's get to it!`;
            greetingModal.classList.add('visible');
        }
    }

    // =================================================================
    // --- 2. TIMER LOGIC ---
    // =================================================================
    function startTimer() {
        if (timerState.running) return;

        const mode = timerModeSelect.value;
        const task = taskDescriptionInput.value || 'Untitled';
        let durationMins, breakMins, category, type;

        if (mode.startsWith('pomo-')) {
            type = 'pomodoro';
            category = 'Work';
            if (mode === 'pomo-25-5') { [durationMins, breakMins] = [25, 5]; }
            else if (mode === 'pomo-90-15') { [durationMins, breakMins] = [90, 15]; }
            else if (mode === 'pomo-60-10') { [durationMins, breakMins] = [60, 10]; }
            else { // custom
                durationMins = parseInt(customWorkInput.value) || 25;
                breakMins = parseInt(customBreakInput.value) || 5;
            }
        } else { // logger
            type = 'logger';
            category = mode.split('-')[1].charAt(0).toUpperCase() + mode.split('-')[1].slice(1);
            durationMins = 24 * 60; // Effectively infinite
            breakMins = 0;
        }
        
        Object.assign(timerState, {
            running: true, paused: false, startTime: Date.now(), accumulatedPauseTime: 0,
            plannedDuration: durationMins * 60, timeRemaining: durationMins * 60,
            type, category, taskDescription: task, isBreak: false, breakDuration: breakMins * 60
        });

        logActivity('Started');
        runTimerTick();
        toggleControls(true);
    }

    function pauseResumeTimer() {
        if (!timerState.running) return;
        timerState.paused = !timerState.paused;

        if (timerState.paused) {
            clearInterval(timerInterval);
            timerState.pauseStartTime = Date.now();
            logActivity('Paused');
        } else { // Resuming
            const pauseDuration = Date.now() - timerState.pauseStartTime;
            timerState.accumulatedPauseTime += pauseDuration;
            logActivity('Resumed');
            runTimerTick();
        }
        updateTimerDisplay();
        toggleControls(true);
    }
    
    function stopTimer() {
        handleSessionEnd(false); // Manually stopped
    }

    function runTimerTick() {
        clearInterval(timerInterval); // Ensure no multiple intervals are running
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - timerState.startTime - timerState.accumulatedPauseTime) / 1000);
            timerState.timeRemaining = timerState.plannedDuration - elapsed;
            
            if (timerState.timeRemaining <= 0) {
                timerState.timeRemaining = 0;
                handleSessionEnd(true); // Completed
            }
            updateTimerDisplay();
        }, 1000);
    }
    
    function handleSessionEnd(completed) {
        clearInterval(timerInterval);
        const endTime = Date.now();
        const actualDuration = (endTime - timerState.startTime - timerState.accumulatedPauseTime);
        
        if (actualDuration > 10000) { // Only log sessions > 10s
             logActivity(completed ? 'Completed' : 'Stopped', { endTime });
        }
        
        const wasPomodoroWork = timerState.type === 'pomodoro' && !timerState.isBreak && completed;
        const breakDurationMins = timerState.breakDuration / 60;

        resetTimerState();
        
        if (wasPomodoroWork && breakDurationMins > 0) {
            const breakCategory = breakDurationMins > 18 ? 'Leisure' : 'Break';
            startBreakSession(breakDurationMins, breakCategory);
        } else {
            updateAllUI();
        }
    }

    function startBreakSession(durationMins, category) {
        Object.assign(timerState, {
            running: true, paused: false, startTime: Date.now(), accumulatedPauseTime: 0,
            plannedDuration: durationMins * 60, timeRemaining: durationMins * 60,
            type: 'pomodoro', category, taskDescription: 'Break', isBreak: true, breakDuration: 0
        });
        logActivity('Started');
        runTimerTick();
        toggleControls(true);
    }

    function resetTimerState() {
        clearInterval(timerInterval);
        Object.assign(timerState, {
            running: false, paused: false, startTime: null, accumulatedPauseTime: 0,
            plannedDuration: 0, timeRemaining: 0, isBreak: false
        });
        toggleControls(false);
        updateTimerDisplay();
    }

    // =================================================================
    // --- 3. UI & METRICS RENDERING ---
    // =================================================================
    function updateAllUI() {
        calculateAndRenderMetrics();
        renderLogPanel();
        updateCharts();
        checkLockedInStatus();
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    function updateTimerDisplay() {
        timerDisplay.textContent = formatTime(timerState.timeRemaining);
        document.title = timerState.running ? `${formatTime(timerState.timeRemaining)} - Dashboard` : 'Productivity Dashboard';
    }

    function calculateAndRenderMetrics() {
        const todayLogs = getLogsForPeriod(1);
        
        let streak = 0;
        const completedLogs = appData.activityLog.filter(log => log.status === 'Completed' || log.status === 'Stopped');
        for (let i = completedLogs.length - 1; i >= 0; i--) {
            if (completedLogs[i].status === 'Completed') {
                streak++;
            } else {
                break;
            }
        }
        streakDisplay.textContent = streak;

        interruptionsValue.textContent = todayLogs.filter(log => log.status === 'Paused').length;
        
        let totalSessionPerc = 0, workSessionCount = 0;
        todayLogs.filter(log => log.status ==='Completed' && log.category === 'Work' && log.plannedDuration > 0).forEach(log => {
            const actualDuration = (log.endTime - log.startTime);
            totalSessionPerc += (actualDuration / (log.plannedDuration * 1000));
            workSessionCount++;
        });
        const focusToday = workSessionCount > 0 ? (totalSessionPerc / workSessionCount) * 100 : 0;
        focusProgressBar.style.width = `${Math.min(100, focusToday)}%`;
        focusProgressBar.textContent = `${Math.round(focusToday)}%`;

        const totalWorkSeconds = todayLogs
            .filter(log => log.status === 'Completed' || log.status === 'Stopped')
            .filter(log => log.category === 'Work')
            .reduce((sum, log) => sum + ((log.endTime - log.startTime) / 1000), 0);
        
        targetHoursDisplay.textContent = appData.goalHours || '-';
        const goalSeconds = (appData.goalHours || 0) * 3600;
        const goalProgress = goalSeconds > 0 ? (totalWorkSeconds / goalSeconds) * 100 : 0;
        goalProgressBar.style.width = `${Math.min(100, goalProgress)}%`;
        goalProgressBar.textContent = `${Math.round(goalProgress)}%`;
    }
    
    function renderLogPanel() {
        logList.innerHTML = '';
        const todayDisplayLogs = getLogsForPeriod(1).filter(l => l.status === 'Completed' || l.status === 'Stopped');
        if (todayDisplayLogs.length === 0) {
            logList.innerHTML = '<li>No activities completed yet today.</li>';
            return;
        }

        todayDisplayLogs.slice().reverse().forEach(log => {
            const li = document.createElement('li');
            li.className = 'log-item';
            const startTime = new Date(log.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const duration = Math.round((log.endTime - log.startTime) / (1000 * 60));

            li.innerHTML = `
                <div>
                    <strong>${log.taskDescription}</strong> (${log.category})
                    <br>
                    <small>${startTime} - ${duration} mins</small>
                </div>
                <span class="status-${log.status.toLowerCase()}">${log.status}</span>
            `;
            logList.appendChild(li);
        });
    }

    function toggleControls(isRunning) {
        startTimerBtn.disabled = isRunning;
        pauseTimerBtn.disabled = !isRunning;
        stopTimerBtn.disabled = !isRunning;
        taskDescriptionInput.disabled = isRunning;
        timerModeSelect.disabled = isRunning;

        if (isRunning) {
            pauseTimerBtn.textContent = timerState.paused ? 'Resume' : 'Pause';
        }
    }

    function checkLockedInStatus() {
        const todayLogs = getLogsForPeriod(1);
        const totalWorkSeconds = todayLogs
            .filter(log => log.status === 'Completed' || log.status === 'Stopped')
            .filter(log => log.category === 'Work')
            .reduce((sum, log) => sum + ((log.endTime - log.startTime) / 1000), 0);

        if (appData.goalHours && totalWorkSeconds >= appData.goalHours * 3600) {
            document.body.classList.add('locked-in');
        } else {
            document.body.classList.remove('locked-in');
        }
    }
    
    // =================================================================
    // --- 4. CHART.JS & HELPERS ---
    // =================================================================
    function initializeCharts() {
        const createChart = (ctx, type, data, options) => new Chart(ctx, { type, data, options });
        const commonOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: 'var(--text-secondary-light)' } } }
        };
        activitiesChart = createChart(document.getElementById('activitiesChart').getContext('2d'), 'doughnut', { datasets: [{ backgroundColor: ['#0a84ff', '#ff9f0a', '#5856d6', '#32d74b'] }] }, { ...commonOptions, plugins: { ...commonOptions.plugins, legend: { position: 'bottom' } } });
        trendChart = createChart(document.getElementById('trendChart').getContext('2d'), 'bar', { datasets: [{ label: 'Work Hours', backgroundColor: 'var(--accent-color-light)', borderRadius: 4 }] }, { ...commonOptions, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-secondary-light)' }, grid: { color: 'var(--border-color-light)' } }, x: { ticks: { color: 'var(--text-secondary-light)' }, grid: { display: false } } } });
    }

    function updateCharts() {
        // Doughnut chart ALWAYS shows today
        const todayLogs = getLogsForPeriod(1).filter(l => l.status === 'Completed' || l.status === 'Stopped');
        const split = todayLogs.reduce((acc, log) => {
            const duration = (log.endTime - log.startTime) / (1000 * 60);
            acc[log.category] = (acc[log.category] || 0) + duration;
            return acc;
        }, {});
        activitiesChart.data.labels = Object.keys(split);
        activitiesChart.data.datasets[0].data = Object.values(split);
        activitiesChart.update();

        // Bar chart shows selected period
        const period = parseInt(document.querySelector('.filter-btn.active').dataset.period);
        const trendLogs = getLogsForPeriod(period).filter(l => (l.status==='Completed' || l.status ==='Stopped') && l.category === 'Work');
        const trendData = {};
        for (let i = 0; i < period; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            trendData[d.toLocaleDateString([], { month: 'short', day: 'numeric' })] = 0;
        }
        trendLogs.forEach(log => {
            const dateLabel = new Date(log.startTime).toLocaleDateString([], { month: 'short', day: 'numeric' });
            if (trendData.hasOwnProperty(dateLabel)) {
                trendData[dateLabel] += (log.endTime - log.startTime) / (1000 * 3600);
            }
        });
        trendChart.data.labels = Object.keys(trendData).reverse();
        trendChart.data.datasets[0].data = Object.values(trendData).reverse();
        trendChart.update();
    }

    function getLogsForPeriod(days) {
        const cutoff = new Date();
        cutoff.setHours(0, 0, 0, 0);
        cutoff.setDate(cutoff.getDate() - (days - 1));
        return appData.activityLog.filter(log => log.timestamp >= cutoff.getTime());
    }
    
    function logActivity(status, extraData = {}) {
        const logEntry = {
            id: Date.now(),
            timestamp: Date.now(),
            category: timerState.category,
            taskDescription: timerState.taskDescription,
            plannedDuration: timerState.plannedDuration,
            startTime: timerState.startTime,
            status,
            ...extraData
        };
        appData.activityLog.push(logEntry);
        saveData();
    }
    
    // =================================================================
    // --- 5. EVENT LISTENERS ---
    // =================================================================
    function setupEventListeners() {
        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            appData.goalHours = parseFloat(goalHoursInput.value);
            appData.lastGreeting = new Date().toDateString();
            saveData();
            greetingModal.classList.remove('visible');
            updateAllUI();
        });

        timerModeSelect.addEventListener('change', () => {
            customPomodoroInputs.style.display = (timerModeSelect.value === 'pomo-custom') ? 'block' : 'none';
        });

        startTimerBtn.addEventListener('click', startTimer);
        pauseTimerBtn.addEventListener('click', pauseResumeTimer);
        stopTimerBtn.addEventListener('click', stopTimer);

        document.querySelector('.chart-filters').addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                updateCharts();
            }
        });

        document.getElementById('exportCsv').addEventListener('click', () => {
            if (appData.activityLog.length === 0) return alert("No data to export!");
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Timestamp,Category,Task,Status,PlannedDuration(s),StartTime,EndTime\n";
            appData.activityLog.forEach(log => {
                const row = [log.id, new Date(log.timestamp).toISOString(), log.category, `"${log.taskDescription.replace(/"/g, '""')}"`, log.status, log.plannedDuration || '', log.startTime ? new Date(log.startTime).toISOString() : '', log.endTime ? new Date(log.endTime).toISOString() : ''].join(',');
                csvContent += row + "\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "productivity_log.csv");
            link.click();
            link.remove();
        });
    }
    
    initializeApp();
});
</script>
</body>
</html>
