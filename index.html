<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        :root {
            --font-main: 'Poppins', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            --bg-color-light: #f0f2f5;
            --glass-bg-light: rgba(255, 255, 255, 0.55);
            --text-color-light: #1c1c1e;
            --text-secondary-light: #5a5a5f;
            --border-color-light: rgba(0, 0, 0, 0.1);
            --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --glow-light: 0 0 15px rgba(31, 38, 135, 0.2);
            --accent-color-light: #007aff;
            --success-color-light: #34c759;
            --warning-color-light: #ff9500;
            --locked-in-glow-light: 0 0 20px rgba(0, 122, 255, 0.6);
            --locked-in-badge-bg-light: #007aff;
            --bg-color-dark: #1c1c1e;
            --glass-bg-dark: rgba(44, 44, 46, 0.7);
            --text-color-dark: #f2f2f7;
            --text-secondary-dark: #b1b1b3;
            --border-color-dark: rgba(255, 255, 255, 0.15);
            --shadow-dark: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --glow-dark: 0 0 15px rgba(0, 122, 255, 0.3);
            --accent-color-dark: #0a84ff;
            --success-color-dark: #32d74b;
            --warning-color-dark: #ff9f0a;
            --locked-in-glow-dark: 0 0 20px rgba(10, 132, 255, 0.7);
            --locked-in-badge-bg-dark: #0a84ff;
        }
        body {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
            font-family: var(--font-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 1rem;
        }
        body.dark-mode {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }
        body.dark-mode .card {
            background: var(--glass-bg-dark);
            border-color: var(--border-color-dark);
            box-shadow: var(--shadow-dark), 0 0 20px rgba(255, 255, 255, 0.08);
        }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 { color: var(--text-color-dark); }
        body.dark-mode h2 { border-bottom-color: var(--border-color-dark); }
        body.dark-mode h3 { color: var(--text-secondary-dark); }
        body.dark-mode button, body.dark-mode input, body.dark-mode select {
            background-color: rgba(120, 120, 128, 0.24);
            color: var(--text-color-dark);
            border-color: var(--border-color-dark);
        }
        body.dark-mode input:disabled { background-color: rgba(120,120,128,0.12); }
        body.dark-mode .log-item { border-bottom-color: var(--border-color-dark); }
        body.dark-mode .chart-filters button, body.dark-mode .chart-view-toggle button {
            border-color: var(--border-color-dark);
            color: var(--text-secondary-dark);
        }
        body.dark-mode .controls-block button.export {
             background-color: rgba(120, 120, 128, 0.24);
             border-color: var(--border-color-dark);
        }
        body.dark-mode .chart-filters button.active, body.dark-mode .chart-view-toggle button.active {
            background-color: var(--accent-color-dark);
            border-color: var(--accent-color-dark);
            color: white;
        }
        body.dark-mode .slider { background-color: #555; }
        input:checked + .slider { background-color: var(--accent-color-dark); }
        body.dark-mode .progress-wrapper { background-color: rgba(120,120,128,0.24); }
        body.dark-mode #goalProgressBar { background-color: var(--success-color-dark); }
        body.dark-mode #lockedInBadge { background-color: var(--locked-in-badge-bg-dark); }
        body.dark-mode button:hover:not(:disabled) { box-shadow: var(--glow-dark); }
        
        .app-wrapper { max-width: 1400px; margin: 0 auto; }
        .card { background: var(--glass-bg-light); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: 1rem; border: 1px solid var(--border-color-light); box-shadow: var(--shadow-light); padding: 1.5rem; transition: all 0.3s ease; }
        .app-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        header { display: flex; justify-content: space-between; align-items: center; }
        main { display: grid; grid-template-areas: "tools" "main-goal" "dashboard" "log"; gap: 1.5rem; }
        #tools { grid-area: tools; }
        #main-goal-display { grid-area: main-goal; }
        #dashboard { grid-area: dashboard; }
        #log-panel { grid-area: log; }

        @media (min-width: 1024px) { 
            main { 
                grid-template-columns: 350px 1fr; 
                grid-template-rows: auto auto 1fr; 
                grid-template-areas: 
                    "tools main-goal"
                    "tools dashboard"
                    "tools log"; 
            } 
        }

        h1, h2, h3 { margin: 0 0 1rem 0; color: var(--text-color-light); font-weight: 600; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.4rem; border-bottom: 1px solid var(--border-color-light); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        h3 { font-size: 1rem; color: var(--text-secondary-light); font-weight: 400; }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 2px; content: ""; height: 20px; left: 2px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color-light); }
        input:checked + .slider:before { transform: translateX(24px); }
        button, input, select { width: 100%; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color-light); background-color: rgba(120,120,128,0.12); color: var(--text-color-light); font-family: var(--font-main); font-size: 1rem; box-sizing: border-box; }
        input:disabled { background-color: rgba(120,120,128,0.06); cursor: not-allowed; }
        button { background-color: var(--accent-color-light); color: white; border: none; cursor: pointer; font-weight: 600; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--glow-light); }
        button.secondary { background-color: var(--text-secondary-light); }
        button:disabled { background-color: #555; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }
        
        #main-goal-display .card { text-align: center; }
        #main-goal-display h2 { font-size: 2rem; border-bottom: none; margin-bottom: 0.5rem; }
        #main-goal-display-text { font-size: 1.5rem; color: var(--text-secondary-light); font-weight: 600; }
        
        #dashboard-content { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 768px) { #dashboard-content { grid-template-columns: 1fr 280px; } }
        .charts-container { display: flex; flex-direction: column; gap: 1.5rem; }
        .chart-wrapper { position: relative; height: 250px; }
        @media (min-width: 768px) { .chart-wrapper { height: 280px; } }
        
        .controls-block {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color-light);
        }
        body.dark-mode .controls-block { border-top-color: var(--border-color-dark); }
        
        .controls-block h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }
        .chart-view-toggle { display: flex; gap: 0.5rem; }
        .chart-view-toggle button, .chart-filters button, button.export { background: none; border: 1px solid var(--border-color-light); color: var(--text-secondary-light); padding: 0.25rem 0.75rem; font-size: 0.8rem; }
        .chart-view-toggle button.active, .chart-filters button.active { background-color: var(--accent-color-light); color: white; border-color: var(--accent-color-light); }
        .chart-filters { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
        
        .stats-sidebar { display: flex; flex-direction: column; gap: 1.25rem; }
        .stats-sidebar h2 { font-size: 1.4rem; }
        .stat-card { padding: 1rem; border: 1px solid var(--border-color-light); border-radius: 1rem; }
        
        .progress-wrapper { background-color: rgba(120,120,128,0.12); border-radius: 0.75rem; padding: 4px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-bar-container { width: 100%; background-color: transparent; border-radius: 0.5rem; overflow: hidden; }
        .progress-bar { width: 0%; height: 22px; background-color: var(--accent-color-light); transition: width 0.5s ease-in-out; text-align: right; color: white; font-size: 0.8rem; line-height: 22px; font-weight: 600; border-radius: 0.5rem; padding: 0 10px; box-sizing: border-box; }
        #goalProgressBar { background-color: var(--success-color-light); }
        .stat-item { text-align: center; }
        .stat-value { font-weight: 700; font-size: 2rem; color: var(--accent-color-light); }
        .stat-label { font-size: 0.9rem; color: var(--text-secondary-light); }
        #interruptionsValue { color: var(--warning-color-light); }
        
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center; }
        #timer-display { font-size: 4rem; font-weight: 700; text-align: center; margin: 1rem 0; color: var(--accent-color-light); }
        #customPomodoroInputs { display: none; }
        .timer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        #log-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color-light); }
        .log-item:last-child { border-bottom: none; }
        .log-item .status-completed { color: var(--success-color-light); font-weight: 600; }
        .log-item .status-stopped { color: #ff3b30; font-weight: 600; }
        #lockedInBadge { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); background-color: var(--locked-in-badge-bg-light); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 600; z-index: 1000; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        body.locked-in #lockedInBadge { opacity: 1; }
        body.locked-in button:hover:not(:disabled) { box-shadow: var(--locked-in-glow-light); }
        #greetingModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #greetingModal.visible { opacity: 1; pointer-events: all; }
        #greetingModal .card { max-width: 400px; text-align: center; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="app-wrapper">
    <div id="lockedInBadge">LOCKED IN</div>

    <div id="greetingModal">
        <div class="card">
            <h2 id="greetingMessage"></h2>
            <p>Set your target for today.</p>
            <form id="goalForm">
                <input type="number" id="goalHoursInput" min="1" max="24" placeholder="Enter Goal Hours (e.g., 8)" required>
                <button type="submit">Set Goal & Start</button>
            </form>
        </div>
    </div>

    <div class="app-container">
        <header>
            <h1>Dashboard</h1>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="themeToggle">
                    <input type="checkbox" id="themeToggle" />
                    <span class="slider round"></span>
                </label>
            </div>
        </header>

        <main>
            <div id="tools" class="card">
                <h2>Tools Suite</h2>
                <div id="timer-display">00:00</div>
                <input type="text" id="taskDescription" placeholder="What are you working on?">
                
                <h3>Timer Mode</h3>
                <select id="timerModeSelect">
                    <optgroup label="Pomodoro">
                        <option value="pomo-25-5">Standard Pomodoro (25/5)</option>
                        <option value="pomo-90-15">Deep Work (90/15)</option>
                        <option value="pomo-60-10">Focused (60/10)</option>
                        <option value="pomo-custom">Custom Pomodoro</option>
                    </optgroup>
                    <optgroup label="Logger">
                        <option value="log-work">Work Logger</option>
                        <option value="log-break">Break Logger</option>
                        <option value="log-leisure">Leisure Logger</option>
                    </optgroup>
                </select>

                <div id="customPomodoroInputs">
                    <input type="number" id="customWork" placeholder="Custom Work (mins)" min="1">
                    <input type="number" id="customBreak" placeholder="Custom Break (mins)" min="1">
                </div>

                <div class="timer-controls">
                    <button id="startTimerBtn">Start</button>
                    <button id="pauseTimerBtn" class="secondary" disabled>Pause</button>
                </div>
                <button id="stopTimerBtn" disabled>Stop</button>

                <div class="controls-block">
                    <h3>Dashboard Controls</h3>
                    <div class="chart-view-toggle">
                        <button id="view-activity-btn" class="active">Activities</button>
                        <button id="view-consistency-btn">Consistency</button>
                    </div>
                </div>
                 <div class="controls-block">
                    <h3>Export Data</h3>
                    <button id="exportCsv" class="export" title="Export to CSV">Export Log to CSV</button>
                </div>
            </div>

            <div id="main-goal-display">
                <div class="card">
                    <h2>Your Daily Goal</h2>
                    <div id="main-goal-display-text">--</div>
                </div>
            </div>

            <div id="dashboard" class="card">
                <div id="dashboard-content">
                    <div class="charts-container">
                        <div id="activity-chart-container">
                            <h2 id="activities-title"></h2>
                            <div class="chart-wrapper">
                                <canvas id="activitiesChart"></canvas>
                            </div>
                        </div>
                        <div id="consistency-chart-container" class="hidden">
                            <h2>Your Consistency</h2>
                             <div class="chart-wrapper">
                                <canvas id="trendChart"></canvas>
                            </div>
                            <div class="chart-filters">
                                <button class="filter-btn active" data-period="7">7 Days</button>
                                <button class="filter-btn" data-period="30">30 Days</button>
                            </div>
                        </div>
                    </div>
                    <div class="stats-sidebar">
                        <h2>How Much Do You Want It?</h2>
                         <div class="stat-card">
                            <h3>Productivity Level</h3>
                            <div class="progress-wrapper">
                                <div class="progress-bar-container">
                                    <div class="progress-bar" id="goalProgressBar"></div>
                                </div>
                            </div>
                        </div>
                         <div class="stat-card">
                            <h3>Your Focus Today</h3>
                            <div class="progress-wrapper">
                                <div class="progress-bar-container">
                                    <div class="progress-bar" id="focusProgressBar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card metrics-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="streak">0</div>
                                <div class="stat-label">Work Streak</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="interruptionsValue">0</div>
                                <div class="stat-label">Interruptions</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="log-panel" class="card">
                <h2>Today's Log</h2>
                <ul id="log-list"></ul>
            </div>
        </main>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM ELEMENT REFERENCES ---
    const greetingModal = document.getElementById('greetingModal');
    const greetingMessage = document.getElementById('greetingMessage');
    const goalForm = document.getElementById('goalForm');
    const goalHoursInput = document.getElementById('goalHoursInput');
    const timerDisplay = document.getElementById('timer-display');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const timerModeSelect = document.getElementById('timerModeSelect');
    const customPomodoroInputs = document.getElementById('customPomodoroInputs');
    const customWorkInput = document.getElementById('customWork');
    const customBreakInput = document.getElementById('customBreak');
    const startTimerBtn = document.getElementById('startTimerBtn');
    const pauseTimerBtn = document.getElementById('pauseTimerBtn');
    const stopTimerBtn = document.getElementById('stopTimerBtn');
    const logList = document.getElementById('log-list');
    const streakDisplay = document.getElementById('streak');
    const interruptionsValue = document.getElementById('interruptionsValue');
    const focusProgressBar = document.getElementById('focusProgressBar');
    const goalProgressBar = document.getElementById('goalProgressBar');
    const mainGoalDisplayText = document.getElementById('main-goal-display-text');
    const activitiesTitle = document.getElementById('activities-title');
    const viewActivityBtn = document.getElementById('view-activity-btn');
    const viewConsistencyBtn = document.getElementById('view-consistency-btn');
    const activityChartContainer = document.getElementById('activity-chart-container');
    const consistencyChartContainer = document.getElementById('consistency-chart-container');

    let activitiesChart, trendChart;
    let appData = { goalHours: null, lastGreeting: null, activityLog: [] };
    let timerInterval = null;
    let timerState = {
        running: false,
        paused: false,
        startTime: null,
        pauseStartTime: null,
        accumulatedPauseTime: 0,
        plannedDuration: 0,
        timeRemaining: 0,
        type: null,
        category: 'Work',
        taskDescription: '',
        isBreak: false,
        breakDuration: 0
    };

    // =================================================================
    // --- 1. INITIALIZATION & DATA ---
    // =================================================================
    function loadData() {
        const savedData = localStorage.getItem('productivityDashboard');
        if (savedData) appData = JSON.parse(savedData);
        if (!Array.isArray(appData.activityLog)) appData.activityLog = [];
    }

    function saveData() {
        localStorage.setItem('productivityDashboard', JSON.stringify(appData));
    }

    function initializeApp() {
        loadData();
        Chart.register(ChartDataLabels);
        setupTheme();
        initializeCharts();
        checkGreeting();
        updateAllUI();
        setupEventListeners();
        const today = new Date();
        const dateString = today.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
        activitiesTitle.textContent = `Today's Activities - ${dateString}`;
    }

    function setupTheme() {
        const themeToggle = document.getElementById('themeToggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        
        const applyTheme = (isDark) => {
            document.body.classList.toggle('dark-mode', isDark);
            themeToggle.checked = isDark;
            const textColor = isDark ? 'rgba(242, 242, 247, 0.8)' : 'rgba(90, 90, 95, 0.8)';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const datalabelColor = '#fff';
            
            if (activitiesChart) {
                activitiesChart.options.plugins.legend.labels.color = textColor;
                activitiesChart.options.plugins.datalabels.color = datalabelColor;
                activitiesChart.update();
            }
            if (trendChart) {
                trendChart.options.plugins.legend.labels.color = textColor;
                trendChart.options.scales.y.ticks.color = textColor;
                trendChart.options.scales.x.ticks.color = textColor;
                trendChart.options.scales.y.grid.color = gridColor;
                trendChart.update();
            }
        };

        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            applyTheme(true);
        } else {
            applyTheme(false);
        }

        themeToggle.addEventListener('change', () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyTheme(isDark);
        });
    }

    function checkGreeting() {
        const today = new Date().toDateString();
        if (appData.lastGreeting !== today || !appData.goalHours) {
            const now = new Date();
            const twoAM = new Date();
            twoAM.setDate(now.getDate() + 1);
            twoAM.setHours(2, 0, 0, 0);

            const hoursLeft = Math.floor((twoAM - now) / (1000 * 60 * 60));
            greetingMessage.textContent = `There are ${hoursLeft} hours left in your day. Let's get to it!`;
            greetingModal.classList.add('visible');
        }
    }

    // =================================================================
    // --- 2. TIMER LOGIC ---
    // =================================================================
    function startTimer() {
        if (timerState.running) return;

        const mode = timerModeSelect.value;
        const task = taskDescriptionInput.value || 'Untitled';
        let durationMins, breakMins, category, type;

        if (mode.startsWith('pomo-')) {
            type = 'pomodoro';
            category = 'Work';
            if (mode === 'pomo-25-5') { [durationMins, breakMins] = [25, 5]; }
            else if (mode === 'pomo-90-15') { [durationMins, breakMins] = [90, 15]; }
            else if (mode === 'pomo-60-10') { [durationMins, breakMins] = [60, 10]; }
            else { // custom
                durationMins = parseInt(customWorkInput.value) || 25;
                breakMins = parseInt(customBreakInput.value) || 5;
            }
            timerState.timeRemaining = durationMins * 60;
        } else { // logger
            type = 'logger';
            category = mode.split('-')[1].charAt(0).toUpperCase() + mode.split('-')[1].slice(1);
            durationMins = 0; // Logger counts up
            breakMins = 0;
            timerState.timeRemaining = 0;
        }
        
        Object.assign(timerState, {
            running: true, paused: false, startTime: Date.now(), accumulatedPauseTime: 0,
            plannedDuration: durationMins * 60,
            type, category, taskDescription: task, isBreak: false, breakDuration: breakMins * 60
        });

        if (!timerState.isBreak) logActivity('Started');
        runTimerTick();
        toggleControls(true);
    }

    function pauseResumeTimer() {
        if (!timerState.running) return;
        timerState.paused = !timerState.paused;

        if (timerState.paused) {
            clearInterval(timerInterval);
            timerState.pauseStartTime = Date.now();
            if (!timerState.isBreak) logActivity('Paused');
        } else { // Resuming
            const pauseDuration = Date.now() - timerState.pauseStartTime;
            timerState.accumulatedPauseTime += pauseDuration;
            if (!timerState.isBreak) logActivity('Resumed');
            runTimerTick();
        }
        updateTimerDisplay();
        toggleControls(true);
    }
    
    function stopTimer() {
        const isWorkLogger = timerState.type === 'logger' && timerState.category === 'Work';
        handleSessionEnd(isWorkLogger); 
    }

    function runTimerTick() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (timerState.type === 'logger') {
                const elapsed = Math.floor((Date.now() - timerState.startTime - timerState.accumulatedPauseTime) / 1000);
                timerState.timeRemaining = elapsed;
            } else {
                 const elapsed = Math.floor((Date.now() - timerState.startTime - timerState.accumulatedPauseTime) / 1000);
                 timerState.timeRemaining = timerState.plannedDuration - elapsed;
                if (timerState.timeRemaining <= 0) {
                    timerState.timeRemaining = 0;
                    handleSessionEnd(true); // Completed
                }
            }
            updateTimerDisplay();
        }, 1000);
    }
    
    function handleSessionEnd(completed) {
        clearInterval(timerInterval);
        
        if (timerState.isBreak) {
            resetTimerState();
            return;
        }

        const endTime = Date.now();
        const actualDuration = (endTime - timerState.startTime - timerState.accumulatedPauseTime);
        
        if (actualDuration >= 60000) { // Only log sessions >= 1 min
             logActivity(completed ? 'Completed' : 'Stopped', { endTime });
        }
        
        const wasPomodoroWork = timerState.type === 'pomodoro' && !timerState.isBreak && completed;
        const breakDurationMins = timerState.breakDuration / 60;

        resetTimerState();
        
        if (wasPomodoroWork && breakDurationMins > 0) {
            const breakCategory = breakDurationMins > 18 ? 'Leisure' : 'Break';
            startBreakSession(breakDurationMins, breakCategory);
        } else {
            updateAllUI();
        }
    }

    function startBreakSession(durationMins, category) {
        Object.assign(timerState, {
            running: true, paused: false, startTime: Date.now(), accumulatedPauseTime: 0,
            plannedDuration: durationMins * 60, timeRemaining: durationMins * 60,
            type: 'pomodoro', category, taskDescription: 'Break', isBreak: true, breakDuration: 0
        });
        runTimerTick();
        toggleControls(true);
    }

    function resetTimerState() {
        clearInterval(timerInterval);
        Object.assign(timerState, {
            running: false, paused: false, startTime: null, accumulatedPauseTime: 0,
            plannedDuration: 0, timeRemaining: 0, isBreak: false
        });
        toggleControls(false);
        updateTimerDisplay();
    }

    // =================================================================
    // --- 3. UI & METRICS RENDERING ---
    // =================================================================
    function updateAllUI() {
        calculateAndRenderMetrics();
        renderLogPanel();
        updateCharts();
        checkLockedInStatus();
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    function updateTimerDisplay() {
        const time = timerState.type === 'logger' && !timerState.isBreak ? timerState.timeRemaining : Math.max(0, timerState.timeRemaining);
        timerDisplay.textContent = formatTime(time);
        const task = timerState.running ? timerState.taskDescription : 'Dashboard';
        document.title = timerState.running ? `${formatTime(time)} - ${task}` : 'Productivity Dashboard';
    }

    function calculateAndRenderMetrics() {
        const todayLogs = getLogsForPeriod(1);
        
        mainGoalDisplayText.textContent = appData.goalHours ? `Target: ${appData.goalHours} Hours` : 'No Goal Set';

        let streak = 0;
        const relevantLogs = appData.activityLog.filter(log => log.status === 'Completed' || log.status === 'Stopped');
        for (let i = relevantLogs.length - 1; i >= 0; i--) {
            if (relevantLogs[i].status === 'Completed' && relevantLogs[i].category === 'Work') {
                streak++;
            } else if(relevantLogs[i].category === 'Work') { // if a work session was stopped, break streak
                break;
            }
        }
        streakDisplay.textContent = streak;

        interruptionsValue.textContent = todayLogs.filter(log => log.status === 'Paused' && log.category === 'Work').length;
        
        let totalSessionPerc = 0, workSessionCount = 0;
        todayLogs.filter(log => (log.status ==='Completed' || log.status === 'Stopped') && log.category === 'Work' && log.plannedDuration > 0).forEach(log => {
            const actualDuration = (log.endTime - log.startTime);
            totalSessionPerc += (actualDuration / (log.plannedDuration * 1000));
            workSessionCount++;
        });
        const focusToday = workSessionCount > 0 ? (totalSessionPerc / workSessionCount) * 100 : 0;
        focusProgressBar.style.width = `${Math.min(100, focusToday)}%`;
        focusProgressBar.textContent = `${Math.round(focusToday)}%`;

        const totalWorkSeconds = todayLogs
            .filter(log => log.status === 'Completed' || log.status === 'Stopped')
            .filter(log => log.category === 'Work')
            .reduce((sum, log) => sum + ((log.endTime - log.startTime) / 1000), 0);
        
        const goalSeconds = (appData.goalHours || 0) * 3600;
        const goalProgress = goalSeconds > 0 ? (totalWorkSeconds / goalSeconds) * 100 : 0;
        goalProgressBar.style.width = `${Math.min(100, goalProgress)}%`;
        goalProgressBar.textContent = `${Math.round(goalProgress)}%`;
    }
    
    function renderLogPanel() {
        logList.innerHTML = '';
        const todayDisplayLogs = getLogsForPeriod(1).filter(l => l.status === 'Completed' || l.status === 'Stopped');
        if (todayDisplayLogs.length === 0) {
            logList.innerHTML = '<li>No activities completed yet today.</li>';
            return;
        }

        todayDisplayLogs.slice().reverse().forEach(log => {
            const li = document.createElement('li');
            li.className = 'log-item';
            const startTime = new Date(log.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const duration = Math.round((log.endTime - log.startTime) / (1000 * 60));

            li.innerHTML = `
                <div>
                    <strong>${log.taskDescription}</strong> (${log.category})
                    <br>
                    <small>${startTime} - ${duration} mins</small>
                </div>
                <span class="status-${log.status.toLowerCase()}">${log.status}</span>
            `;
            logList.appendChild(li);
        });
    }

    function toggleControls(isRunning) {
        startTimerBtn.disabled = isRunning;
        pauseTimerBtn.disabled = !isRunning;
        stopTimerBtn.disabled = !isRunning;
        taskDescriptionInput.disabled = isRunning;
        timerModeSelect.disabled = isRunning;

        if (isRunning) {
            pauseTimerBtn.textContent = timerState.paused ? 'Resume' : 'Pause';
        }
    }

    function checkLockedInStatus() {
        const todayLogs = getLogsForPeriod(1);
        const totalWorkSeconds = todayLogs
            .filter(log => log.status === 'Completed' || log.status === 'Stopped')
            .filter(log => log.category === 'Work')
            .reduce((sum, log) => sum + ((log.endTime - log.startTime) / 1000), 0);

        if (appData.goalHours && totalWorkSeconds >= appData.goalHours * 3600) {
            document.body.classList.add('locked-in');
        } else {
            document.body.classList.remove('locked-in');
        }
    }
    
    // =================================================================
    // --- 4. CHART.JS & HELPERS ---
    // =================================================================
    function initializeCharts() {
        const createChart = (ctx, type, data, options) => new Chart(ctx, { type, data, options });
        const commonOptions = (isDark = false) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { labels: { color: isDark ? 'rgba(242, 242, 247, 0.8)' : 'rgba(90, 90, 95, 0.8)' } },
                datalabels: {
                    formatter: (value, ctx) => {
                        const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        if (sum === 0) return '';
                        const percentage = ((value / sum) * 100);
                        return percentage > 5 ? percentage.toFixed(0) + '%' : '';
                    },
                    color: '#fff',
                    font: { weight: 'bold' }
                }
            }
        });
        activitiesChart = createChart(document.getElementById('activitiesChart').getContext('2d'), 'doughnut', { datasets: [{ backgroundColor: ['#0a84ff', '#ff9f0a', '#5856d6', '#32d74b', '#ff3b30'] }] }, { ...commonOptions(document.body.classList.contains('dark-mode')), plugins: { ...commonOptions(document.body.classList.contains('dark-mode')).plugins, legend: { position: 'bottom' } } });
        trendChart = createChart(document.getElementById('trendChart').getContext('2d'), 'bar', { datasets: [{ label: 'Consistency', backgroundColor: 'var(--accent-color-light)', borderRadius: 4 }] }, { ...commonOptions(document.body.classList.contains('dark-mode')), plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: document.body.classList.contains('dark-mode') ? 'rgba(242, 242, 247, 0.8)' : 'rgba(90, 90, 95, 0.8)', callback: (value) => value + '%' } , grid: { color: document.body.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' } }, x: { ticks: { color: document.body.classList.contains('dark-mode') ? 'rgba(242, 242, 247, 0.8)' : 'rgba(90, 90, 95, 0.8)' }, grid: { display: false } } } });
    }

    function updateCharts() {
        // Doughnut chart ALWAYS shows today
        const todayLogs = getLogsForPeriod(1).filter(l => l.status === 'Completed' || l.status === 'Stopped');
        const split = todayLogs.reduce((acc, log) => {
            const duration = (log.endTime - log.startTime) / (1000 * 60);
            acc[log.category] = (acc[log.category] || 0) + duration;
            return acc;
        }, {});
        activitiesChart.data.labels = Object.keys(split);
        activitiesChart.data.datasets[0].data = Object.values(split);
        activitiesChart.update();

        // Bar chart shows selected period
        const period = parseInt(document.querySelector('.chart-filters .filter-btn.active').dataset.period);
        const trendLogs = getLogsForPeriod(period).filter(l => (l.status==='Completed' || l.status ==='Stopped') && l.category === 'Work');
        const trendData = {};
        for (let i = 0; i < period; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            trendData[d.toLocaleDateString([], { month: 'short', day: 'numeric' })] = 0;
        }
        trendLogs.forEach(log => {
            const dateLabel = new Date(log.startTime).toLocaleDateString([], { month: 'short', day: 'numeric' });
            if (trendData.hasOwnProperty(dateLabel)) {
                trendData[dateLabel] += (log.endTime - log.startTime) / (1000 * 3600);
            }
        });

        const goalHours = appData.goalHours || 8; // Default to 8 if no goal set
        const consistencyData = Object.values(trendData).map(hours => goalHours > 0 ? Math.min(100, (hours / goalHours) * 100) : 0);

        trendChart.data.labels = Object.keys(trendData).reverse();
        trendChart.data.datasets[0].data = consistencyData.reverse();
        trendChart.update();
    }

    function getLogsForPeriod(days) {
        const cutoff = new Date();
        cutoff.setHours(0, 0, 0, 0);
        cutoff.setDate(cutoff.getDate() - (days - 1));
        return appData.activityLog.filter(log => log.timestamp >= cutoff.getTime());
    }
    
    function logActivity(status, extraData = {}) {
        const logEntry = {
            id: Date.now(),
            timestamp: Date.now(),
            category: timerState.category,
            taskDescription: timerState.taskDescription,
            plannedDuration: timerState.plannedDuration,
            startTime: timerState.startTime,
            status,
            ...extraData
        };
        appData.activityLog.push(logEntry);
        saveData();
    }
    
    // =================================================================
    // --- 5. EVENT LISTENERS ---
    // =================================================================
    function setupEventListeners() {
        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            appData.goalHours = parseFloat(goalHoursInput.value);
            appData.lastGreeting = new Date().toDateString();
            saveData();
            greetingModal.classList.remove('visible');
            updateAllUI();
        });

        timerModeSelect.addEventListener('change', () => {
            customPomodoroInputs.style.display = (timerModeSelect.value === 'pomo-custom') ? 'block' : 'none';
        });

        startTimerBtn.addEventListener('click', startTimer);
        pauseTimerBtn.addEventListener('click', pauseResumeTimer);
        stopTimerBtn.addEventListener('click', stopTimer);

        document.querySelector('.chart-filters').addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.chart-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                updateCharts();
            }
        });

        document.getElementById('exportCsv').addEventListener('click', () => {
            if (appData.activityLog.length === 0) return alert("No data to export!");
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Timestamp,Category,Task,Status,PlannedDuration(s),StartTime,EndTime\n";
            appData.activityLog.forEach(log => {
                const row = [log.id, new Date(log.timestamp).toISOString(), log.category, `"${log.taskDescription.replace(/"/g, '""')}"`, log.status, log.plannedDuration || '', log.startTime ? new Date(log.startTime).toISOString() : '', log.endTime ? new Date(log.endTime).toISOString() : ''].join(',');
                csvContent += row + "\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "productivity_log.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        viewActivityBtn.addEventListener('click', () => {
            activityChartContainer.classList.remove('hidden');
            consistencyChartContainer.classList.add('hidden');
            viewActivityBtn.classList.add('active');
            viewConsistencyBtn.classList.remove('active');
        });

        viewConsistencyBtn.addEventListener('click', () => {
            activityChartContainer.classList.add('hidden');
            consistencyChartContainer.classList.remove('hidden');
            viewActivityBtn.classList.remove('active');
            viewConsistencyBtn.classList.add('active');
        });
    }
    
    initializeApp();
});
</script>
</body>
</html>
